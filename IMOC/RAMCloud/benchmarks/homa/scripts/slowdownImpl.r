#!/usr/bin/Rscript
library(reshape2)
library(ggplot2)
library(grid)
library(gridExtra)
library(plyr)


# Plots the stretch vs. unsched bytes from text data files generated by
# PlotDigeter.py script
stretch <- read.table("slowdownImpl.txt",
    na.strings = "NA", col.names=c('TransportType', 'LoadFactor', 'WorkLoad',
    'MsgSizeRange', 'SizeCnt', 'SizeCntPercent', 'MedianStretch',
    'TailStretch'), header=FALSE)

stretch$LoadFactor <- factor(stretch$LoadFactor)
stretch$SizeCntPercent <- 100 * stretch$SizeCntPercent
stretch$TransportType <- as.character(stretch$TransportType)

allTtypes <- unique(stretch$TransportType)
selectTtypes <- c("Basic", "HomaP1O4", "HomaP1O7", "HomaP2O4",
    "HomaP2O7", "HomaP4O4", "HomaP4O7", "HomaP8O4", "HomaP8O7", "InfRC",
    "InfRC-Multi", "TCP-Multi")
replaceTtypes <- c("Basic", "HomaP1", "HomaP1", "HomaP2",
    "HomaP2", "HomaP4", "HomaP4", "Homa", "Homa", "InfRC", "InfRC-MC",
    "TCP-MC")
tTypesColors <- c('Basic' = '#377eb8', "HomaP1" = '#7cae00',
    "HomaP2" = '#984ea3', "HomaP4" = '#00bfc4', "Homa" = '#e41a1c',
    "InfRC" = '#000000', "InfRC-MC" = '#7e7e7e', "TCP-MC" = '#ff8833')
stretch <- subset(stretch, TransportType %in% selectTtypes)
#stretch$TransportType <- factor(stretch$TransportType)

reorderTtype <- function(df) {
    ttList <- c()
    stretchList <- c()
    for (tt in unique(df$TransportType)) {
        tmp1 <- subset(df, TransportType==tt)
        ind <- findInterval(c(20), tmp1$SizeCumPercent)
        val <- tmp1[ind,][[length(tmp1)]]
        ttList <- c(ttList, tt)
        stretchList <- c(stretchList, val)
    }
    ttOrdered <- ttList[order(stretchList,decreasing=TRUE)]
    dfOrdered <- read.table(text="", col.names=colnames(df))
    for (tt in ttOrdered) {
        dfOrdered<-rbind(dfOrdered, df[which(df$TransportType %in% c(tt)),])
    }
    return(list(dfOrdered=dfOrdered, ttOrdered=ttOrdered))
}

stretch <- ddply(stretch,
    .(TransportType, LoadFactor, WorkLoad),
    transform, SizeCntPercent = SizeCnt/sum(as.numeric(SizeCnt))*100,
    SizeCumPercent = cumsum(as.numeric(SizeCnt))/sum(as.numeric(SizeCnt))*100)

workloads <- levels(stretch$WorkLoad)
#lineColors = c('#2F4F4F', '#7cae00','#00bfc4', '#ff8833',
#     '#377eb8', '#984ea3', '#e41a1c', '#000000', '#a65628', '#b9ffd1',
#     '#f781bf','#ff7f00', '#fff68f', '#c77cff')
textSize <- 35
titleSize <- 35

i <- 0
tailStretchPlot = list()
for (workload in workloads) {
    rhos = unique(stretch[stretch$WorkLoad == workload,]$LoadFactor)
    for (rho in rhos) {
        # Use CDF as the x axis
        tmp <- subset(stretch, WorkLoad==workload & LoadFactor==rho,
            select=c('LoadFactor', 'WorkLoad', 'MsgSizeRange', 'SizeCntPercent',
            'SizeCumPercent', 'TransportType', 'TailStretch'))

        ret <- reorderTtype(tmp)
        tmp = ret$dfOrdered
        ttOrdered = ret$ttOrdered
        tmp$TransportType <- factor(tmp$TransportType, levels=ttOrdered)


        if (nrow(tmp) == 0) {
            next
        }

        #use this order c('Homa', 'Basic')
        #ttypeLevels <- levels(tmp$TransportType)
        #myOrder <- c(ttypeLevels[2], ttypeLevels[1])
        #tmp$TransportType <- factor(tmp$TransportType, levels = myOrder)

        i <- i+1
        plotTitle = sprintf("Workload: %s, LoadFac: %s", workload, rho)

        yLab = '99% Slowdown (Log Scale)\n'
        xLab = ''
        if (match(workload, workloads) == length(workloads) &
                match(workload, workloads) == length(rhos)) {
            xLab <- 'Message Size (Bytes)'
        }

        yLimit <- 7500
        yLimit <- min(max(tmp$TailStretch), yLimit)
        tailStretchPlot[[i]] <- ggplot() +
            geom_step(data=tmp, aes(x=SizeCumPercent-SizeCntPercent/2,
            y=TailStretch, width=SizeCntPercent, colour=TransportType),
            size=3)

        brks = seq(10,100,10)
        #xIntervals <- findInterval(brks,
        #    tmp[tmp$TransportType=='Homa',]$SizeCumPercent)
        #brkLabels<-tmp[xIntervals,]$MsgSizeRange
        ttSample = as.character(tmp$TransportType)[1]
        sizeCum <- tmp[tmp$TransportType==ttSample,]$SizeCumPercent
        msgRange <- tmp[tmp$TransportType==ttSample,]$MsgSizeRange
        brkLabels <-sapply(brks, function(x) min(msgRange[sizeCum>=x]))

        theme_i <- theme_classic() +
            theme(text = element_text(size=1.5*textSize, color='black'),
                axis.text = element_text(size=1.3*textSize),
                axis.text.x = element_text(angle=45, vjust=0.5),
                axis.title.x = element_text(vjust = 3),
                strip.text = element_text(size = textSize),
                panel.background = element_rect(fill = "white"),
                panel.grid.major = element_line(size = 0.01,
                    linetype = 'dotted', colour = "lightgray"),
                plot.title = element_text(size = 1.5*textSize,
                    color='darkblue', vjust=-9),
                legend.position = c(1, 0.5),
                plot.margin=unit(c(-.5,1.9,-.5,0),"cm"),
                legend.text = element_text(size=1.2*textSize),
                legend.title = element_blank())

        tailStretchPlot[[i]] <- tailStretchPlot[[i]] +
            guides(colour = guide_legend(override.aes = list(size=textSize/2)))+
            scale_x_continuous(limits = c(0,101), breaks = brks,
                labels=brkLabels, expand = c(0, 0)) +
            theme_i +
            scale_y_log10(breaks=c(1,2,3,4,5,10,15,20,50,100,1000,yLimit)) +
            coord_cartesian(ylim=c(1, yLimit)) +
            labs(title = plotTitle, y = yLab, x = xLab) +
            scale_color_manual(values = tTypesColors)

    }
}

pdf("slowdownImpl.pdf", width=20, height=10.5*length(workloads))
args.list <- c(tailStretchPlot, list(ncol=1))
do.call(grid.arrange, args.list)
dev.off()

i <- 1
tailStretchPlot = list()
for (workload in workloads) {
    rhos = unique(stretch[stretch$WorkLoad == workload,]$LoadFactor)
    for (rho in rhos) {
        # Use CDF as the x axis
        tmp <- subset(stretch, WorkLoad==workload & LoadFactor==rho,
            select=c('LoadFactor', 'WorkLoad', 'MsgSizeRange', 'SizeCntPercent',
            'SizeCumPercent', 'TransportType', 'TailStretch'))
        ret <- reorderTtype(tmp)
        tmp = ret$dfOrdered
        ttOrdered = ret$ttOrdered
        tmp$TransportType <- factor(tmp$TransportType, levels=ttOrdered)
        ttypes <- replaceTtypes[match(levels(tmp$TransportType), selectTtypes)]
        levels(tmp$TransportType) <- ttypes


        if (nrow(tmp) == 0) {
            next
        }

        #use this order c('Homa', 'Basic')
        #ttypeLevels <- levels(tmp$TransportType)
        #myOrder <- c(ttypeLevels[2], ttypeLevels[1])
        #tmp$TransportType <- factor(tmp$TransportType, levels = myOrder)

        plotTitle = sprintf("Workload: %s", toupper(workload), rho)

        yLab = '99% Slowdown (Log Scale)\n'
        xLab <- 'Message Size (Bytes)'

        yLimit <- 7500
        yLimit <- as.integer(ceiling(min(max(tmp$TailStretch), yLimit)))
        tailStretchPlot[[i]] <- ggplot() +
            geom_step(data=tmp, aes(x=SizeCumPercent-SizeCntPercent/2,
            y=TailStretch, width=SizeCntPercent, colour=TransportType),
            size=3)

        brks = seq(10,100,10)
        #xIntervals <- findInterval(brks,
        #    tmp[tmp$TransportType=='Homa',]$SizeCumPercent)
        #brkLabels<-tmp[xIntervals,]$MsgSizeRange
        ttSample = as.character(tmp$TransportType)[1]
        sizeCum <- tmp[tmp$TransportType==ttSample,]$SizeCumPercent
        msgRange <- tmp[tmp$TransportType==ttSample,]$MsgSizeRange
        brkLabels <-sapply(brks, function(x) min(msgRange[sizeCum>=x]))

        theme_i <- theme_classic() +
            theme(text = element_text(size=1.5*textSize, color='black'),
                axis.text = element_text(size=1.3*textSize),
                axis.text.x = element_text(angle=45, vjust=0.7),
                axis.title.x = element_text(vjust = 6),
                axis.title.y = element_text(vjust = -7.3),
                strip.text = element_text(size = textSize),
                panel.background = element_rect(fill = "white"),
                panel.grid.major = element_line(size = 0.01,
                    linetype = 'dotted', colour = "lightgray"),
                plot.title = element_text(size = 1.5*textSize,
                    color='darkblue', hjust=.5, vjust=-1),
                legend.position = c(1.15, 0.5),
                plot.margin=unit(c(-.5,9,-1,-2),"cm"),
                legend.text = element_text(size=1.2*textSize),
                legend.title = element_blank())

        tailStretchPlot[[i]] <- tailStretchPlot[[i]] +
            guides(colour = guide_legend(override.aes = list(size=textSize/2)))+
            scale_x_continuous(limits = c(0,101), breaks = brks,
                labels=brkLabels, expand = c(0, 0)) +
            theme_i +
            scale_y_log10(breaks=c(1,2,3,5,10,20,50,100,1000,yLimit)) +
            coord_cartesian(ylim=c(1, yLimit)) +
            labs(title = plotTitle, y = yLab, x = xLab) +
            scale_color_manual(values = tTypesColors)

        pdf(sprintf("impl/slowdownImpl_%s_rho%s_tail.pdf", workload, rho),
            width=18, height=16)
        args.list <- c(tailStretchPlot, list(ncol=1))
        do.call(grid.arrange, args.list)
        dev.off()
    }
}

medianStretchPlot = list()
i <- 1
for (workload in workloads) {
    rhos = unique(stretch[stretch$WorkLoad == workload,]$LoadFactor)
    for (rho in rhos) {
        # Use CDF as the x axis
        tmp <- subset(stretch, WorkLoad==workload & LoadFactor==rho,
            select=c('LoadFactor', 'WorkLoad', 'MsgSizeRange', 'SizeCntPercent',
            'SizeCumPercent', 'TransportType', 'MedianStretch'))
        ret <- reorderTtype(tmp)
        tmp = ret$dfOrdered
        ttOrdered = ret$ttOrdered
        tmp$TransportType <- factor(tmp$TransportType, levels=ttOrdered)


        if (nrow(tmp) == 0) {
            next
        }

        #use this order c('Homa', 'Basic')
        #ttypeLevels <- levels(tmp$TransportType)
        #myOrder <- c(ttypeLevels[2], ttypeLevels[1])
        #tmp$TransportType <- factor(tmp$TransportType, levels = myOrder)

        plotTitle = sprintf("Workload: %s", workload)

        yLab = '50% Slowdown (Log Scale)\n'
        xLab <- 'Message Size (Bytes)'

        yLimit <- 100
        yLimit <- min(max(tmp$MedianStretch), yLimit)

        medianStretchPlot[[i]] <- ggplot() +
            geom_step(data=tmp, aes(x=SizeCumPercent-SizeCntPercent/2,
            y=MedianStretch, width=SizeCntPercent, colour=TransportType),
            size=3)

        brks = seq(10,100,10)
        #xIntervals <- findInterval(brks,
        #    tmp[tmp$TransportType=='Homa',]$SizeCumPercent)
        #brkLabels<-tmp[xIntervals,]$MsgSizeRange
        ttSample = as.character(tmp$TransportType)[1]
        sizeCum <- tmp[tmp$TransportType==ttSample,]$SizeCumPercent
        msgRange <- tmp[tmp$TransportType==ttSample,]$MsgSizeRange
        brkLabels <-sapply(brks, function(x) min(msgRange[sizeCum>=x]))

        theme_i <- theme_classic() +
            theme(text = element_text(size=1.5*textSize, color='black'),
                axis.text = element_text(size=1.3*textSize),
                axis.text.x = element_text(angle=45, vjust=0.5),
                axis.title.x = element_text(vjust = 3),
                strip.text = element_text(size = textSize),
                panel.background = element_rect(fill = "white"),
                panel.grid.major = element_line(size = 0.01,
                    linetype = 'dotted', colour = "lightgray"),
                plot.title = element_text(size = 1.5*textSize,
                    color='darkblue', vjust=-9),
                legend.position = c(0.16, 0.77),
                plot.margin=unit(c(-.5,1.9,-.5,0),"cm"),
                legend.text = element_text(size=1.2*textSize),
                legend.title = element_blank())

        medianStretchPlot[[i]] <- medianStretchPlot[[i]] +
            guides(colour = guide_legend(override.aes = list(size=textSize/2)))+
            scale_x_continuous(limits = c(0,101), breaks = brks,
                labels=brkLabels, expand = c(0, 0)) +
            theme_i +
            scale_y_log10(breaks=c(1,2,3,4,5,10,15,20,50,100)) +
            coord_cartesian(ylim=c(1, yLimit)) +
            labs(title = plotTitle, y = yLab, x = xLab) +
            scale_color_manual(values = tTypesColors)

        pdf(sprintf("impl/slowdownImpl_%s_rho%s_median.pdf",workload, rho),
            width=18, height=16)
        args.list <- c(medianStretchPlot, list(ncol=1))
        do.call(grid.arrange, args.list)
        dev.off()
    }
}

i <- 0
tailStretchPlot = list()
rhos <- c(76)
workloads <- c("W3", "W4", "W5")
for (workload in workloads) {
    for (rho in rhos) {
        # Use CDF as the x axis
        tmp <- subset(stretch, WorkLoad==workload & LoadFactor==rho,
            select=c('LoadFactor', 'WorkLoad', 'MsgSizeRange', 'SizeCntPercent',
            'SizeCumPercent', 'TransportType', 'TailStretch'))
        ret <- reorderTtype(tmp)
        tmp = ret$dfOrdered
        ttOrdered = ret$ttOrdered
        tmp$TransportType <- factor(tmp$TransportType, levels=ttOrdered)
        ttypes <- replaceTtypes[match(levels(tmp$TransportType), selectTtypes)]
        levels(tmp$TransportType) <- ttypes


        if (nrow(tmp) == 0) {
            next
        }

        #use this order c('Homa', 'Basic')
        #ttypeLevels <- levels(tmp$TransportType)
        #myOrder <- c(ttypeLevels[2], ttypeLevels[1])
        #tmp$TransportType <- factor(tmp$TransportType, levels = myOrder)

        plotTitle = sprintf("Workload: %s", toupper(workload), rho)

        xLab <- 'Message Size (Bytes)'
        yLab = ''
        if (workload == workloads[1]) {
            yLab = '99% Slowdown (Log Scale)'
        }

        yLimit <- 7500
        yLimit <- as.integer(ceiling(min(max(tmp$TailStretch), yLimit)))

        i <- i+1
        tailStretchPlot[[i]] <- ggplot() +
            geom_step(data=tmp, aes(x=SizeCumPercent-SizeCntPercent/2,
            y=TailStretch, width=SizeCntPercent, colour=TransportType),
            size=3)

        brks = seq(10,100,10)
        #xIntervals <- findInterval(brks,
        #    tmp[tmp$TransportType=='Homa',]$SizeCumPercent)
        #brkLabels<-tmp[xIntervals,]$MsgSizeRange
        ttSample = as.character(tmp$TransportType)[1]
        sizeCum <- tmp[tmp$TransportType==ttSample,]$SizeCumPercent
        msgRange <- tmp[tmp$TransportType==ttSample,]$MsgSizeRange
        brkLabels <-sapply(brks, function(x) min(msgRange[sizeCum>=x]))

        theme_i <- theme_classic() +
            theme(text = element_text(size=1.5*textSize, color='black'),
                axis.text = element_text(size=1.3*textSize),
                axis.text.x = element_text(angle=45, vjust=0.7),
                axis.title.x = element_text(vjust = 8),
                #axis.title.y = element_text(hjust = .85),
                strip.text = element_text(size = textSize),
                panel.background = element_rect(fill = "white"),
                panel.grid.major = element_line(size = 0.01,
                    linetype = 'dotted', colour = "lightgray"),
                plot.title = element_text(size = 1.5*textSize,
                    color='darkblue', hjust=.5, vjust=-1))

        if (workload == workloads[length(workloads)]) {
            theme_i <- theme_i +
                theme(legend.position = c(1.11, 0.5),
                legend.text = element_text(size=1.2*textSize),
                legend.title = element_blank(),
                plot.margin=unit(c(-0.2, 9, -1.6, -2.5),"cm"))
        } else if (workload == workloads[1]) {
            theme_i <- theme_i +
                theme(legend.position = "none",
                plot.margin=unit(c(-0.2, 2.5, -1.6, 0),"cm"))
        } else {
            theme_i <- theme_i +
                theme(legend.position = "none",
                plot.margin=unit(c(-0.2, 2.5, -1.6, -2.5),"cm"))
        }


        tailStretchPlot[[i]] <- tailStretchPlot[[i]] +
            guides(colour = guide_legend(override.aes = list(size=textSize/2)))+
            scale_x_continuous(limits = c(0,101), breaks = brks,
                labels=brkLabels, expand = c(0, 0)) +
            theme_i +
            scale_y_log10(breaks=c(1,2,3,5,10,20,50,100,1000,yLimit)) +
            coord_cartesian(ylim=c(1, yLimit)) +
            labs(title = plotTitle, y = yLab, x = xLab) +
            scale_color_manual(values = tTypesColors)

    }
}

pdf(sprintf("impl/slowdownImpl_tailCombined.pdf", workload, rho),
    width=54, height=16)
args.list <- c(tailStretchPlot, list(ncol=i), list(widths=c(3.15,3,3.5)))
do.call(grid.arrange, args.list)
dev.off()

